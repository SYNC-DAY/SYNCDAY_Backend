FROM docker.elastic.co/elasticsearch/elasticsearch:7.17.9

USER root

# 필요한 패키지 설치
RUN apt-get update && apt-get install -y curl
RUN elasticsearch-plugin install analysis-nori

# 설정 파일 복사
COPY config/elasticsearch/elasticsearch.yml /usr/share/elasticsearch/config/
COPY config/elasticsearch/indices/ /usr/share/elasticsearch/config/indices/
COPY config/elasticsearch/init-index.sh /usr/share/elasticsearch/config/init-index.sh
COPY config/elasticsearch/healthcheck.sh /usr/share/elasticsearch/

# entrypoint 스크립트 생성
RUN echo '#!/bin/bash' > /usr/local/bin/docker-entrypoint-custom.sh && \
    echo 'set -e' >> /usr/local/bin/docker-entrypoint-custom.sh && \
    echo 'mkdir -p /usr/share/elasticsearch/data' >> /usr/local/bin/docker-entrypoint-custom.sh && \
    echo 'mkdir -p /usr/share/elasticsearch/logs' >> /usr/local/bin/docker-entrypoint-custom.sh && \
    echo 'chown -R elasticsearch:elasticsearch /usr/share/elasticsearch/data' >> /usr/local/bin/docker-entrypoint-custom.sh && \
    echo 'chown -R elasticsearch:elasticsearch /usr/share/elasticsearch/logs' >> /usr/local/bin/docker-entrypoint-custom.sh && \
    echo '/usr/local/bin/docker-entrypoint.sh elasticsearch -d' >> /usr/local/bin/docker-entrypoint-custom.sh && \
    echo 'until curl -s http://localhost:9200/_cluster/health | grep -q "\"status\":\"green\""; do' >> /usr/local/bin/docker-entrypoint-custom.sh && \
    echo '    echo "Waiting for ElasticSearch to start..."' >> /usr/local/bin/docker-entrypoint-custom.sh && \
    echo '    sleep 5' >> /usr/local/bin/docker-entrypoint-custom.sh && \
    echo 'done' >> /usr/local/bin/docker-entrypoint-custom.sh && \
    echo 'echo "Elasticsearch is ready. Running init-index.sh..."' >> /usr/local/bin/docker-entrypoint-custom.sh && \
    echo '/usr/share/elasticsearch/config/init-index.sh' >> /usr/local/bin/docker-entrypoint-custom.sh && \
    echo 'exec /usr/local/bin/docker-entrypoint.sh elasticsearch' >> /usr/local/bin/docker-entrypoint-custom.sh && \
    chmod +x /usr/local/bin/docker-entrypoint-custom.sh

# 디렉토리 생성 및 권한 설정 (더 세밀한 권한 관리)
RUN mkdir -p /usr/share/elasticsearch/data && \
    mkdir -p /usr/share/elasticsearch/logs && \
    chown -R elasticsearch:elasticsearch /usr/share/elasticsearch && \
    chmod 755 /usr/share/elasticsearch && \
    chmod 755 /usr/share/elasticsearch/data && \
    chmod 755 /usr/share/elasticsearch/logs && \
    chmod -R 755 /usr/share/elasticsearch/config && \
    chmod +x /usr/share/elasticsearch/config/init-index.sh && \
    chmod +x /usr/share/elasticsearch/healthcheck.sh

# 환경 변수 설정
ENV discovery.type=single-node
ENV ES_JAVA_OPTS="-Xms512m -Xmx512m -Xlog:gc*=info:stderr"
ENV bootstrap.memory_lock=true
ENV xpack.security.enabled=false
ENV node.max_local_storage_nodes=10

USER elasticsearch

ENTRYPOINT ["/usr/local/bin/docker-entrypoint-custom.sh"]